{% extends "base.html" %}

{% block title %}Settings{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 24px;">
    <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">$ guardian config --edit</div>
    <h1 style="color: var(--brand-cyan); font-size: 20px; font-weight: normal; margin: 0;">System Configuration</h1>
</div>

<form id="settingsForm">
    <!-- Plex Settings -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º Plex Configuration</h2>
            <button type="button" class="btn btn-primary" onclick="testPlex()">Test Connection</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>PLEX_TOKEN</label>
                <input type="password" name="PLEX_TOKEN" required>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Your Plex authentication token</div>
            </div>

            <div class="form-group">
                <label>SERVER_NAME</label>
                <input type="text" name="PLEX_SERVER_NAME">
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Display name for your server</div>
            </div>

            <div id="plexStatus"></div>
        </div>
    </div>

    <!-- Tautulli Settings -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º Tautulli Configuration</h2>
            <button type="button" class="btn btn-primary" onclick="testTautulli()">Test Connection</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>TAUTULLI_URL</label>
                <input type="url" name="TAUTULLI_URL" required placeholder="http://192.168.1.100:8181">
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Full URL to your Tautulli instance (e.g., http://192.168.1.100:8181)</div>
            </div>

            <div class="form-group">
                <label>API_KEY</label>
                <input type="password" name="TAUTULLI_API_KEY" required>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Tautulli API key from Settings â†’ Web Interface</div>
            </div>

            <div id="tautulliStatus"></div>
        </div>
    </div>

    <!-- Email Settings -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º Email Configuration</h2>
            <button type="button" class="btn btn-primary" onclick="testEmail()">Send Test Email</button>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: 3fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label>SMTP_SERVER</label>
                    <input type="text" name="SMTP_HOST" value="smtp.gmail.com" required>
                </div>

                <div class="form-group">
                    <label>PORT</label>
                    <input type="number" name="SMTP_PORT" value="587" required>
                </div>
            </div>

            <div class="form-group">
                <label>EMAIL_ADDRESS</label>
                <input type="email" name="SMTP_USERNAME" required>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Gmail address to send from</div>
            </div>

            <div class="form-group">
                <label>APP_PASSWORD</label>
                <input type="password" name="SMTP_PASSWORD" required>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Gmail app password (not your regular password)</div>
            </div>

            <div class="form-group">
                <label>FROM_NAME</label>
                <input type="text" name="SMTP_FROM" placeholder='"Plex Admin" <you@gmail.com>'>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Display name in sent emails</div>
            </div>

            <div class="form-group">
                <label>ADMIN_EMAIL</label>
                <input type="email" name="ADMIN_EMAIL" required>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Where to send admin notifications</div>
            </div>

            <div id="emailStatus"></div>
        </div>
    </div>

    <!-- Discord Settings -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º Discord Integration (Optional)</h2>
            <button type="button" class="btn btn-primary" onclick="testDiscord()">Send Test Message</button>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>WEBHOOK_URL</label>
                <input type="url" name="DISCORD_WEBHOOK" placeholder="https://discord.com/api/webhooks/...">
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Discord webhook for real-time notifications</div>
            </div>

            <div class="form-group">
                <label>YOUR_DISCORD_PROFILE_LINK</label>
                <input type="url" name="LINK_DISCORD" placeholder="https://discord.com/users/123456789">
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Optional link to your Discord profile</div>
            </div>

            <div id="discordStatus"></div>
        </div>
    </div>

    <!-- Thresholds & Intervals -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º Thresholds & Intervals</h2>
        </div>
        <div class="card-body">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                <div class="form-group">
                    <label>WARNING_THRESHOLD (days)</label>
                    <input type="number" name="WARN_DAYS" value="27" min="1" required>
                    <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Send warning after this many days of inactivity</div>
                </div>

                <div class="form-group">
                    <label>REMOVAL_THRESHOLD (days)</label>
                    <input type="number" name="KICK_DAYS" value="30" min="1" required>
                    <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Remove user after this many days of inactivity</div>
                </div>

                <div class="form-group">
                    <label>NEW_USER_CHECK (seconds)</label>
                    <input type="number" name="CHECK_NEW_USERS_SECS" value="120" min="10" required>
                    <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">How often to check for new users</div>
                </div>

                <div class="form-group">
                    <label>INACTIVITY_CHECK (seconds)</label>
                    <input type="number" name="CHECK_INACTIVITY_SECS" value="1800" min="60" required>
                    <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">How often to check user activity</div>
                </div>
            </div>
        </div>
    </div>

    <!-- VIP Protection -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º VIP Protection</h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label>PROTECTED_USERNAMES</label>
                <textarea name="VIP_NAMES" rows="3" placeholder="friend1,family_member,bestfriend"></textarea>
                <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">Comma-separated list of usernames to protect from auto-removal</div>
            </div>
        </div>
    </div>

    <!-- Operating Mode -->
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">â–º Operating Mode</h2>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 12px; cursor: pointer; padding: 12px; background: var(--term-surface-2); border: 1px solid var(--term-border); border-radius: 4px;">
                    <input type="checkbox" name="DRY_RUN" id="dryRunCheckbox" style="width: 18px; height: 18px; cursor: pointer;">
                    <div>
                        <div style="font-weight: bold; color: var(--text-primary);">DRY_RUN Mode</div>
                        <div style="color: var(--text-muted); font-size: 11px; margin-top: 4px;">
                            When enabled, all actions are logged but NOT executed (no emails sent, no users removed)
                        </div>
                    </div>
                </label>
            </div>

            <div class="alert alert-info">
                <strong>âš  Important:</strong> Keep DRY RUN enabled when testing. Disable only when ready for live operation.
            </div>
        </div>
    </div>

    <!-- Save Button -->
    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-bottom: 24px;">
        <button type="button" class="btn" onclick="location.reload()">Cancel</button>
        <button type="submit" class="btn btn-success">ðŸ’¾ Save Configuration</button>
    </div>
</form>

<!-- Backup & Restore -->
<div class="card" style="margin-bottom: 24px;">
    <div class="card-header">
        <h2 class="card-title">â–º Backup & Restore</h2>
    </div>
    <div class="card-body">
        <div style="display: grid; gap: 16px;">
            <!-- Backup Section -->
            <div style="padding: 12px; background: var(--term-surface-2); border: 1px solid var(--term-border); border-radius: 4px;">
                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                    <div>
                        <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 4px;">Create Backup</div>
                        <div style="color: var(--text-muted); font-size: 11px;">
                            Download configuration and user state data
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="downloadBackup()">
                        ðŸ“¦ Download Backup
                    </button>
                </div>
                <div style="color: var(--text-muted); font-size: 10px; padding: 8px; background: var(--term-surface); border-radius: 4px;">
                    <strong>Includes:</strong> .env configuration, state.json (user data, warning history)
                </div>
            </div>

            <!-- Restore Section -->
            <div style="padding: 12px; background: var(--term-surface-2); border: 1px solid var(--term-border); border-radius: 4px;">
                <div style="margin-bottom: 12px;">
                    <div style="font-weight: bold; color: var(--text-primary); margin-bottom: 4px;">Restore from Backup</div>
                    <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 12px;">
                        Upload a previously saved backup file
                    </div>
                </div>
                <div style="display: flex; gap: 12px; align-items: center;">
                    <input type="file" id="restoreFile" accept=".zip" style="flex: 1; padding: 8px; background: var(--term-surface); border: 1px solid var(--term-border); border-radius: 4px; color: var(--text-primary); font-family: monospace; font-size: 12px;">
                    <button type="button" class="btn btn-warning" onclick="restoreBackup()">
                        ðŸ“¥ Restore
                    </button>
                </div>
                <div class="alert alert-danger" style="margin-top: 12px;">
                    <strong>âš  Warning:</strong> Restoring will overwrite current configuration and user data. Daemon will restart.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentConfig = {};

async function loadConfig() {
    try {
        currentConfig = await API.get('/api/config');
        
        // Populate form
        Object.keys(currentConfig).forEach(key => {
            const input = document.querySelector(`[name="${key}"]`);
            if (input) {
                if (input.type === 'checkbox') {
                    input.checked = currentConfig[key] === 'true';
                } else {
                    input.value = currentConfig[key] || '';
                }
            }
        });
    } catch (error) {
        showAlert(`Failed to load configuration: ${error.message}`, 'error');
    }
}

document.getElementById('settingsForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const config = {};
    
    for (let [key, value] of formData.entries()) {
        config[key] = value;
    }
    
    // Handle checkbox separately
    config.DRY_RUN = document.getElementById('dryRunCheckbox').checked ? 'true' : 'false';
    
    try {
        await API.post('/api/config', config);
        showAlert('Configuration saved successfully!', 'success');
        setTimeout(() => location.reload(), 1500);
    } catch (error) {
        showAlert(`Failed to save: ${error.message}`, 'error');
    }
});

async function testPlex() {
    showTestStatus('plexStatus', 'Testing Plex connection...', 'info');
    
    try {
        const config = getFormConfig();
        const result = await API.post('/api/test/plex', config);
        showTestStatus('plexStatus', 
            `âœ“ Connected as ${result.username} (${result.user_count} users found)`, 
            'success'
        );
    } catch (error) {
        showTestStatus('plexStatus', `âœ— Connection failed: ${error.message}`, 'error');
    }
}

async function testTautulli() {
    showTestStatus('tautulliStatus', 'Testing Tautulli connection...', 'info');
    
    try {
        const config = getFormConfig();
        const result = await API.post('/api/test/tautulli', config);
        showTestStatus('tautulliStatus', 
            `âœ“ Connected (${result.user_count} users found)`, 
            'success'
        );
    } catch (error) {
        showTestStatus('tautulliStatus', `âœ— Connection failed: ${error.message}`, 'error');
    }
}

async function testEmail() {
    const email = document.querySelector('[name="ADMIN_EMAIL"]').value;
    if (!email) {
        showAlert('Please enter an admin email address first', 'error');
        return;
    }

    showTestStatus('emailStatus', `Sending test email to ${email}...`, 'info');
    
    try {
        const config = getFormConfig();
        await API.post('/api/test/email', { ...config, email });
        showTestStatus('emailStatus', 
            `âœ“ Test email sent to ${email}. Check your inbox!`, 
            'success'
        );
    } catch (error) {
        showTestStatus('emailStatus', `âœ— Email failed: ${error.message}`, 'error');
    }
}

async function testDiscord() {
    const webhook = document.querySelector('[name="DISCORD_WEBHOOK"]').value;
    if (!webhook) {
        showAlert('Please enter a Discord webhook URL first', 'error');
        return;
    }

    showTestStatus('discordStatus', 'Sending test Discord notifications...', 'info');
    
    try {
        const config = getFormConfig();
        await API.post('/api/test/discord', config);
        showTestStatus('discordStatus', 
            'âœ“ Test messages sent to Discord. Check your channel!', 
            'success'
        );
    } catch (error) {
        showTestStatus('discordStatus', `âœ— Discord test failed: ${error.message}`, 'error');
    }
}

function getFormConfig() {
    const formData = new FormData(document.getElementById('settingsForm'));
    const config = {};
    for (let [key, value] of formData.entries()) {
        config[key] = value;
    }
    config.DRY_RUN = document.getElementById('dryRunCheckbox').checked ? 'true' : 'false';
    return config;
}

function showTestStatus(elementId, message, type) {
    const statusDiv = document.getElementById(elementId);
    statusDiv.innerHTML = `<div class="alert alert-${type === 'error' ? 'danger' : type}">${message}</div>`;
    
    if (type === 'success' || type === 'danger') {
        setTimeout(() => {
            statusDiv.innerHTML = '';
            }, 5000);
        }
    }

    // Backup & Restore Functions
    async function downloadBackup() {
        try {
            showAlert('Creating backup...', 'info');
            const response = await fetch('/api/backup', {
                method: 'GET'
            });
            
            if (!response.ok) {
                throw new Error('Failed to create backup');
            }
            
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `guardian-backup-${new Date().toISOString().split('T')[0]}.zip`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showAlert('âœ“ Backup downloaded successfully', 'success');
        } catch (error) {
            showAlert(`Failed to download backup: ${error.message}`, 'error');
        }
    }

    async function restoreBackup() {
        const fileInput = document.getElementById('restoreFile');
        const file = fileInput.files[0];
        
        if (!file) {
            showAlert('Please select a backup file first', 'error');
            return;
        }
        
        if (!confirm('âš  WARNING: This will overwrite your current configuration and user data. The daemon will restart. Continue?')) {
            return;
        }
        
        try {
            showAlert('Restoring backup...', 'info');
            
            const formData = new FormData();
            formData.append('backup', file);
            
            const response = await fetch('/api/restore', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.status === 'success') {
                showAlert('âœ“ Backup restored successfully. Reloading...', 'success');
                setTimeout(() => location.reload(), 2000);
            } else {
                throw new Error(result.message || 'Restore failed');
            }
        } catch (error) {
            showAlert(`Failed to restore backup: ${error.message}`, 'error');
        }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadConfig);
</script>
{% endblock %}
