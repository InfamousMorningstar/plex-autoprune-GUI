{% extends "base.html" %}

{% block title %}Logs{% endblock %}

{% block content %}
<h1 style="color: var(--centauri-cyan); margin-bottom: 2rem;">System Logs</h1>

<!-- Controls -->
<div class="card" style="margin-bottom: 1.5rem;">
    <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
        <!-- Filter Buttons -->
        <div style="flex: 1; display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="btn btn-sm btn-primary active" data-level="ALL" onclick="filterLogs('ALL')">
                All
            </button>
            <button class="btn btn-sm" data-level="INFO" onclick="filterLogs('INFO')" style="background: #3b82f6;">
                INFO
            </button>
            <button class="btn btn-sm" data-level="SUCCESS" onclick="filterLogs('SUCCESS')" style="background: #10b981;">
                SUCCESS
            </button>
            <button class="btn btn-sm" data-level="WARNING" onclick="filterLogs('WARNING')" style="background: #f59e0b;">
                WARNING
            </button>
            <button class="btn btn-sm" data-level="ERROR" onclick="filterLogs('ERROR')" style="background: #ef4444;">
                ERROR
            </button>
        </div>

        <!-- Search -->
        <input 
            type="text" 
            id="logSearch" 
            class="form-input" 
            placeholder="Search logs..." 
            style="max-width: 300px;"
            oninput="searchLogs()"
        >

        <!-- Auto-scroll Toggle -->
        <label style="display: flex; align-items: center; gap: 0.5rem; margin: 0; cursor: pointer;">
            <input type="checkbox" id="autoScroll" checked style="width: 18px; height: 18px;">
            <span style="white-space: nowrap;">Auto-scroll</span>
        </label>

        <!-- Action Buttons -->
        <button class="btn btn-secondary" onclick="exportLogs()">
            üì• Export
        </button>
        <button class="btn btn-secondary" onclick="clearLogs()">
            üóëÔ∏è Clear
        </button>
    </div>
</div>

<!-- Log Viewer -->
<div class="card" style="padding: 0;">
    <div id="logContainer" style="
        max-height: 600px;
        overflow-y: auto;
        font-family: 'Courier New', monospace;
        font-size: 13px;
        background: #000;
        padding: 1rem;
        border-radius: 8px;
    ">
        <div id="logContent"></div>
        <div id="logLoading" style="color: #6b7280; text-align: center; padding: 2rem;">
            Loading logs...
        </div>
    </div>
</div>

<!-- Stats -->
<div class="card" style="margin-top: 1.5rem;">
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; text-align: center;">
        <div>
            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">Total Logs</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: var(--centauri-cyan);" id="totalLogs">0</div>
        </div>
        <div>
            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">INFO</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #3b82f6;" id="infoCount">0</div>
        </div>
        <div>
            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">SUCCESS</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #10b981;" id="successCount">0</div>
        </div>
        <div>
            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">WARNING</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #f59e0b;" id="warningCount">0</div>
        </div>
        <div>
            <div style="color: var(--text-muted); font-size: 0.875rem; margin-bottom: 0.25rem;">ERROR</div>
            <div style="font-size: 1.5rem; font-weight: bold; color: #ef4444;" id="errorCount">0</div>
        </div>
    </div>
</div>

<script>
    let allLogs = [];
    let filteredLogs = [];
    let currentFilter = 'ALL';
    let searchQuery = '';

    const levelColors = {
        'INFO': '#3b82f6',
        'SUCCESS': '#10b981',
        'WARNING': '#f59e0b',
        'ERROR': '#ef4444',
        'DEBUG': '#6b7280'
    };

    // Load initial logs
    async function loadInitialLogs() {
        try {
            const response = await fetch('/api/logs');
            const data = await response.json();
            allLogs = data.logs || [];
            applyFilters();
            document.getElementById('logLoading').style.display = 'none';
        } catch (error) {
            console.error('Failed to load logs:', error);
            document.getElementById('logLoading').innerHTML = 
                '<span style="color: #ef4444;">Failed to load logs</span>';
        }
    }

    // WebSocket for real-time logs
    if (window.socket) {
        socket.on('log', (log) => {
            allLogs.push(log);
            
            // Limit to 1000 logs in memory
            if (allLogs.length > 1000) {
                allLogs.shift();
            }
            
            applyFilters();
        });
    }

    function applyFilters() {
        // Filter by level
        filteredLogs = allLogs;
        
        if (currentFilter !== 'ALL') {
            filteredLogs = filteredLogs.filter(log => log.level === currentFilter);
        }
        
        // Filter by search
        if (searchQuery) {
            const query = searchQuery.toLowerCase();
            filteredLogs = filteredLogs.filter(log => 
                log.message.toLowerCase().includes(query) ||
                (log.timestamp && log.timestamp.toLowerCase().includes(query))
            );
        }
        
        renderLogs();
        updateStats();
    }

    function renderLogs() {
        const container = document.getElementById('logContent');
        const autoScroll = document.getElementById('autoScroll').checked;
        const logContainer = document.getElementById('logContainer');
        const wasAtBottom = logContainer.scrollHeight - logContainer.scrollTop <= logContainer.clientHeight + 50;
        
        container.innerHTML = filteredLogs.map(log => {
            const color = levelColors[log.level] || '#6b7280';
            const timestamp = log.timestamp || new Date().toISOString().replace('T', ' ').substring(0, 19);
            
            return `
                <div style="
                    margin-bottom: 0.5rem;
                    padding: 0.5rem;
                    border-left: 3px solid ${color};
                    background: rgba(${hexToRgb(color)}, 0.1);
                    border-radius: 4px;
                ">
                    <div style="display: flex; gap: 1rem; align-items: center;">
                        <span style="color: #6b7280; font-size: 11px; white-space: nowrap;">${timestamp}</span>
                        <span style="
                            background: ${color};
                            color: #000;
                            padding: 2px 8px;
                            border-radius: 4px;
                            font-size: 11px;
                            font-weight: bold;
                            white-space: nowrap;
                        ">${log.level}</span>
                        <span style="color: #e5e7eb; flex: 1;">${escapeHtml(log.message)}</span>
                    </div>
                </div>
            `;
        }).join('');
        
        // Auto-scroll if enabled and was at bottom
        if (autoScroll && wasAtBottom) {
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    }

    function filterLogs(level) {
        currentFilter = level;
        
        // Update button states
        document.querySelectorAll('[data-level]').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.level === level);
        });
        
        applyFilters();
    }

    function searchLogs() {
        searchQuery = document.getElementById('logSearch').value;
        applyFilters();
    }

    function updateStats() {
        const counts = {
            INFO: 0,
            SUCCESS: 0,
            WARNING: 0,
            ERROR: 0
        };
        
        allLogs.forEach(log => {
            if (counts.hasOwnProperty(log.level)) {
                counts[log.level]++;
            }
        });
        
        document.getElementById('totalLogs').textContent = allLogs.length;
        document.getElementById('infoCount').textContent = counts.INFO;
        document.getElementById('successCount').textContent = counts.SUCCESS;
        document.getElementById('warningCount').textContent = counts.WARNING;
        document.getElementById('errorCount').textContent = counts.ERROR;
    }

    function exportLogs() {
        const text = filteredLogs.map(log => {
            const timestamp = log.timestamp || new Date().toISOString();
            return `[${timestamp}] [${log.level}] ${log.message}`;
        }).join('\n');
        
        const blob = new Blob([text], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
    a.download = `plex-auto-prune-gui-logs-${new Date().toISOString().slice(0, 10)}.txt`;
        a.click();
        URL.revokeObjectURL(url);
        
        showAlert('Logs exported successfully!', 'success');
    }

    function clearLogs() {
        if (confirm('Clear all logs? This cannot be undone.')) {
            allLogs = [];
            applyFilters();
            showAlert('Logs cleared', 'success');
        }
    }

    function hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result 
            ? `${parseInt(result[1], 16)}, ${parseInt(result[2], 16)}, ${parseInt(result[3], 16)}`
            : '107, 114, 128';
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', loadInitialLogs);
</script>

<style>
    /* Custom scrollbar for log container */
    #logContainer::-webkit-scrollbar {
        width: 8px;
    }

    #logContainer::-webkit-scrollbar-track {
        background: #1a1a1a;
    }

    #logContainer::-webkit-scrollbar-thumb {
        background: var(--centauri-cyan);
        border-radius: 4px;
    }

    #logContainer::-webkit-scrollbar-thumb:hover {
        background: var(--centauri-purple);
    }

    /* Button active state */
    .btn.active {
        box-shadow: 0 0 0 2px var(--centauri-cyan);
    }
</style>
{% endblock %}
