{% extends "base.html" %}

{% block title %}Logs{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 24px;">
    <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">$ guardian logs --follow --level=all</div>
    <h1 style="color: var(--brand-cyan); font-size: 20px; font-weight: normal; margin: 0;">System Logs</h1>
</div>

<!-- Controls -->
<div class="card">
    <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap; padding: 16px;">
        <!-- Filter Buttons -->
        <div style="flex: 1; display: flex; gap: 6px; flex-wrap: wrap;">
            <button class="btn btn-sm" data-level="ALL" onclick="filterLogs('ALL')" style="background: var(--brand-primary);">
                ALL
            </button>
            <button class="btn btn-sm" data-level="INFO" onclick="filterLogs('INFO')" style="background: var(--brand-cyan);">
                INFO
            </button>
            <button class="btn btn-sm" data-level="SUCCESS" onclick="filterLogs('SUCCESS')" style="background: var(--brand-success);">
                SUCCESS
            </button>
            <button class="btn btn-sm" data-level="WARNING" onclick="filterLogs('WARNING')" style="background: var(--brand-warning);">
                WARNING
            </button>
            <button class="btn btn-sm" data-level="ERROR" onclick="filterLogs('ERROR')" style="background: var(--brand-danger);">
                ERROR
            </button>
        </div>

        <!-- Search -->
        <input 
            type="text" 
            id="logSearch" 
            placeholder="Search logs..." 
            style="max-width: 300px;"
            oninput="searchLogs()"
        >

        <!-- Auto-scroll Toggle -->
        <label style="display: flex; align-items: center; gap: 8px; margin: 0; cursor: pointer; color: var(--text-secondary); font-size: 12px;">
            <input type="checkbox" id="autoScroll" checked style="width: 16px; height: 16px; cursor: pointer;">
            <span style="white-space: nowrap;">Auto-scroll</span>
        </label>

        <!-- Action Buttons -->
        <div class="btn-group">
            <button class="btn" onclick="exportLogs()">↓ Export</button>
            <button class="btn btn-danger" onclick="clearLogs()">✗ Clear</button>
        </div>
    </div>
</div>

<!-- Log Viewer -->
<div class="card" style="padding: 0;">
    <div class="terminal-output" id="logContainer" style="max-height: 500px; min-height: 300px;">
        <div id="logContent"></div>
        <div id="logLoading" style="color: var(--text-muted); text-align: center; padding: 40px; font-size: 11px;">
            > Loading logs...
        </div>
    </div>
</div>

<!-- Stats -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px; margin-top: 24px;">
    <div class="stat-card">
        <div class="stat-label">TOTAL LOGS</div>
        <div class="stat-value" id="totalLogs">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">INFO</div>
        <div class="stat-value" style="color: var(--brand-cyan);" id="infoCount">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">SUCCESS</div>
        <div class="stat-value" style="color: var(--brand-success);" id="successCount">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">WARNING</div>
        <div class="stat-value" style="color: var(--brand-warning);" id="warningCount">0</div>
    </div>
    <div class="stat-card">
        <div class="stat-label">ERROR</div>
        <div class="stat-value" style="color: var(--brand-danger);" id="errorCount">0</div>
    </div>
</div>

<style>
.btn-sm {
    padding: 6px 14px;
    font-size: 11px;
    opacity: 0.7;
    transition: opacity 0.15s, background 0.15s;
}

.btn-sm:hover {
    opacity: 1;
}

.btn-sm.active {
    opacity: 1;
    box-shadow: 0 0 0 2px rgba(122, 92, 255, 0.3);
}

.log-line {
    padding: 4px 0;
    font-size: 12px;
    line-height: 1.6;
    border-left: 2px solid transparent;
    padding-left: 12px;
    margin-left: -12px;
    transition: background 0.1s;
}

.log-line:hover {
    background: rgba(255, 255, 255, 0.03);
}

.log-timestamp {
    color: var(--text-muted);
    margin-right: 12px;
    font-size: 11px;
}

.log-level {
    display: inline-block;
    min-width: 70px;
    margin-right: 12px;
    font-weight: bold;
    font-size: 10px;
    text-align: center;
    padding: 2px 6px;
    border-radius: 2px;
}

.log-level-INFO { color: var(--brand-cyan); border-left-color: var(--brand-cyan); }
.log-level-SUCCESS { color: var(--brand-success); border-left-color: var(--brand-success); }
.log-level-WARNING { color: var(--brand-warning); border-left-color: var(--brand-warning); }
.log-level-ERROR { color: var(--brand-danger); border-left-color: var(--brand-danger); }
.log-level-DEBUG { color: var(--text-muted); border-left-color: var(--text-muted); }

.log-message {
    color: var(--text-primary);
}
</style>

<script>
let allLogs = [];
let filteredLogs = [];
let currentFilter = 'ALL';
let searchQuery = '';

// Load initial logs
async function loadInitialLogs() {
    try {
        const response = await fetch('/api/logs');
        const data = await response.json();
        allLogs = data.logs || [];
        applyFilters();
        document.getElementById('logLoading').style.display = 'none';
    } catch (error) {
        console.error('Failed to load logs:', error);
        document.getElementById('logLoading').innerHTML = 
            '<span style="color: var(--brand-danger);">✗ Failed to load logs</span>';
    }
}

// WebSocket for real-time logs
if (window.socket) {
    socket.on('log', (log) => {
        allLogs.push(log);
        
        // Limit to 1000 logs in memory
        if (allLogs.length > 1000) {
            allLogs.shift();
        }
        
        applyFilters();
    });
}

function applyFilters() {
    // Filter by level
    filteredLogs = allLogs;
    
    if (currentFilter !== 'ALL') {
        filteredLogs = filteredLogs.filter(log => log.level === currentFilter);
    }
    
    // Filter by search
    if (searchQuery) {
        const query = searchQuery.toLowerCase();
        filteredLogs = filteredLogs.filter(log => 
            log.message.toLowerCase().includes(query) ||
            (log.timestamp && log.timestamp.toLowerCase().includes(query))
        );
    }
    
    renderLogs();
    updateStats();
}

function renderLogs() {
    const container = document.getElementById('logContent');
    const autoScroll = document.getElementById('autoScroll').checked;
    const logContainer = document.getElementById('logContainer');
    const wasAtBottom = logContainer.scrollHeight - logContainer.scrollTop <= logContainer.clientHeight + 50;
    
    if (filteredLogs.length === 0) {
        container.innerHTML = '<div style="color: var(--text-muted); text-align: center; padding: 40px; font-size: 11px;">> No logs to display</div>';
        return;
    }
    
    container.innerHTML = filteredLogs.map(log => {
        const timestamp = log.timestamp || new Date().toISOString().replace('T', ' ').substring(0, 19);
        
        return `
            <div class="log-line log-level-${log.level}">
                <span class="log-timestamp">${timestamp}</span>
                <span class="log-level">${log.level}</span>
                <span class="log-message">${escapeHtml(log.message)}</span>
            </div>
        `;
    }).join('');
    
    // Auto-scroll if enabled and was at bottom
    if (autoScroll && wasAtBottom) {
        logContainer.scrollTop = logContainer.scrollHeight;
    }
}

function filterLogs(level) {
    currentFilter = level;
    
    // Update button states
    document.querySelectorAll('[data-level]').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.level === level);
    });
    
    applyFilters();
}

function searchLogs() {
    searchQuery = document.getElementById('logSearch').value;
    applyFilters();
}

function updateStats() {
    const counts = {
        INFO: 0,
        SUCCESS: 0,
        WARNING: 0,
        ERROR: 0
    };
    
    allLogs.forEach(log => {
        if (counts.hasOwnProperty(log.level)) {
            counts[log.level]++;
        }
    });
    
    document.getElementById('totalLogs').textContent = allLogs.length;
    document.getElementById('infoCount').textContent = counts.INFO;
    document.getElementById('successCount').textContent = counts.SUCCESS;
    document.getElementById('warningCount').textContent = counts.WARNING;
    document.getElementById('errorCount').textContent = counts.ERROR;
}

function exportLogs() {
    const text = filteredLogs.map(log => {
        const timestamp = log.timestamp || new Date().toISOString();
        return `[${timestamp}] [${log.level}] ${log.message}`;
    }).join('\n');
    
    const blob = new Blob([text], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `guardian-logs-${new Date().toISOString().slice(0, 10)}.txt`;
    a.click();
    URL.revokeObjectURL(url);
    
    showAlert('Logs exported successfully!', 'success');
}

function clearLogs() {
    if (confirm('Clear all logs? This cannot be undone.')) {
        allLogs = [];
        applyFilters();
        showAlert('Logs cleared', 'success');
    }
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Initialize - set ALL filter as active by default
document.addEventListener('DOMContentLoaded', () => {
    document.querySelector('[data-level="ALL"]').classList.add('active');
    loadInitialLogs();
});
</script>
{% endblock %}
