{% extends "base.html" %}

{% block title %}Email History{% endblock %}

{% block content %}
<!-- Page Header -->
<div style="margin-bottom: 24px;">
    <div style="color: var(--text-muted); font-size: 11px; margin-bottom: 4px;">$ guardian emails --history --limit=100</div>
    <h1 style="color: var(--brand-cyan); font-size: 20px; font-weight: normal; margin: 0;">Email Send History</h1>
</div>

<div class="card">
    <div class="card-header">
        <h2 class="card-title">Email Log (<span id="totalEmails">0</span>)</h2>
        <button class="btn" onclick="refreshHistory()">
            <span id="refreshIcon">↻</span> Refresh
        </button>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>Timestamp</th>
                    <th>Recipient</th>
                    <th>Subject</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="emailHistoryTable">
                <tr>
                    <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">
                        Loading email history...
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<style>
.status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 3px;
    font-size: 10px;
    font-weight: bold;
    text-transform: uppercase;
    letter-spacing: 0.3px;
}

.status-success {
    background: rgba(16, 185, 129, 0.15);
    color: var(--brand-success);
    border: 1px solid rgba(16, 185, 129, 0.3);
}

.status-error {
    background: rgba(220, 38, 38, 0.15);
    color: var(--brand-danger);
    border: 1px solid rgba(220, 38, 38, 0.3);
}

.timestamp {
    font-size: 11px;
    color: var(--text-muted);
}

tbody tr:hover {
    background: var(--term-surface-2);
}
</style>

<script>
let emailHistory = [];

async function loadEmailHistory() {
    try {
        const result = await API.get('/api/email-history');
        emailHistory = result.emails || [];
        
        document.getElementById('totalEmails').textContent = emailHistory.length;
        
        renderEmailHistory();
    } catch (error) {
        showAlert(`Failed to load email history: ${error.message}`, 'error');
    }
}

function renderEmailHistory() {
    const tbody = document.getElementById('emailHistoryTable');
    
    if (emailHistory.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">
                    No emails sent yet
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = emailHistory.map(email => {
        const timestamp = new Date(email.timestamp);
        const formattedTime = timestamp.toLocaleString();
        const statusClass = email.status === 'success' ? 'status-success' : 'status-error';
        
        return `
            <tr>
                <td class="timestamp">${formattedTime}</td>
                <td>${email.to}</td>
                <td>${email.subject}</td>
                <td>
                    <span class="status-badge ${statusClass}">
                        ${email.status === 'success' ? '✓ Sent' : '✗ Failed'}
                    </span>
                    ${email.error ? `<br><small style="color: var(--brand-danger); font-size: 10px; margin-top: 4px; display: block;">${email.error}</small>` : ''}
                </td>
            </tr>
        `;
    }).join('');
}

async function refreshHistory() {
    const icon = document.getElementById('refreshIcon');
    icon.style.transform = 'rotate(360deg)';
    icon.style.transition = 'transform 0.5s';
    
    await loadEmailHistory();
    
    setTimeout(() => {
        icon.style.transform = 'rotate(0deg)';
    }, 500);
}

// Load on page load
document.addEventListener('DOMContentLoaded', loadEmailHistory);

// Auto-refresh every 30 seconds
setInterval(loadEmailHistory, 30000);
</script>
{% endblock %}
